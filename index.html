<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Garden Box Builder ‚Äî Custom Cedar Raised Beds</title>
  <meta property="og:title" content="Garden Box Builder ‚Äî Custom Cedar Raised Beds">
  <meta property="og:description" content="Design your custom cedar raised garden beds, get an instant quote & share your build specs">
  <meta property="og:image" content="https://maxschmeling.github.io/garden-box-calculator/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://maxschmeling.github.io/garden-box-calculator/">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Garden Box Builder ‚Äî Custom Cedar Raised Beds">
  <meta name="twitter:description" content="Design your custom cedar raised garden beds, get an instant quote & share your build specs">
  <meta name="twitter:image" content="https://maxschmeling.github.io/garden-box-calculator/og-image.png">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { overflow-x: hidden; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #e0e0e0;
      min-height: 100vh;
      overflow-x: hidden;
      max-width: 100vw;
    }
    header {
      background: linear-gradient(135deg, #16213e, #0f3460);
      padding: 24px 32px;
      border-bottom: 2px solid #e94560;
    }
    header h1 { font-size: 1.8rem; color: #fff; }
    header p { color: #a0a0b0; margin-top: 4px; font-size: 0.95rem; }
    .container {
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
      padding: 24px;
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 24px;
    }
    @media (max-width: 900px) {
      .container { grid-template-columns: 1fr !important; padding: 12px; gap: 16px; width: 100%; max-width: 100vw; }
      header { padding: 16px 20px; }
      header h1 { font-size: 1.4rem; }
      .panel { padding: 16px; }
      #viewer { min-height: 0 !important; height: 150px !important; }
      .viewer-wrap { max-width: 100vw; overflow: hidden; }
      .result-line { font-size: 0.8rem; flex-wrap: wrap; gap: 2px; }
      .result-line .value { font-size: 0.8rem; }
      .viewer-controls { justify-content: center; }
    }
    @media (max-width: 480px) {
      .container { padding: 8px; gap: 12px; }
      header { padding: 12px 16px; }
      header h1 { font-size: 1.2rem; }
      .panel { padding: 12px; }
      .box-entry { padding: 12px; }
      #viewer { min-height: 0 !important; height: 150px !important; }
      .result-line { flex-direction: column; gap: 0; }
      .result-line .value { text-align: left; }
      .total-line { flex-direction: column; gap: 4px; }
      .total-line .value { text-align: left; }
    }
    .panel {
      background: #16213e;
      border-radius: 12px;
      padding: 24px;
      border: 1px solid #0f3460;
      min-width: 0;
    }
    .panel canvas { display: block; }
    .panel h2 {
      font-size: 1.1rem;
      color: #e94560;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #0f3460;
    }
    .box-entry {
      background: #1a1a2e;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid #0f3460;
      position: relative;
      min-width: 0;
    }
    .box-entry .box-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    .box-entry .box-header span { font-weight: 600; color: #e94560; }
    .box-entry .box-header .header-left { display: flex; align-items: center; gap: 8px; }
    .box-entry .box-header .toggle-icon { font-size: 0.7rem; color: #888; transition: transform 0.2s; }
    .box-entry.collapsed .toggle-icon { transform: rotate(-90deg); }
    .box-entry .box-summary { font-size: 0.8rem; color: #888; margin-left: 4px; }
    .box-entry .box-body { margin-top: 12px; overflow: hidden; transition: max-height 0.2s ease; max-height: 500px; }
    .box-entry.collapsed .box-body { max-height: 0; margin-top: 0; }
    .box-entry .header-actions { display: flex; align-items: center; gap: 4px; }
    .box-entry .remove-btn {
      background: none; border: none; color: #666; cursor: pointer;
      font-size: 1.2rem; padding: 2px 8px; border-radius: 4px;
    }
    .box-entry .remove-btn:hover { color: #e94560; background: rgba(233,69,96,0.1); }
    .field-row { display: flex; flex-direction: column; gap: 8px; margin-bottom: 8px; }
    .field { display: flex; flex-direction: column; }
    .field label { font-size: 0.75rem; color: #888; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
    .field input, .field select {
      background: #16213e; border: 1px solid #0f3460; color: #e0e0e0;
      padding: 8px 10px; border-radius: 6px; font-size: 0.9rem; width: 100%;
    }
    .field input:focus, .field select:focus { outline: none; border-color: #e94560; }
    .qty-row { display: flex; flex-direction: column; gap: 8px; }
    button.primary {
      background: #e94560; color: #fff; border: none; padding: 10px 20px;
      border-radius: 8px; font-size: 0.9rem; cursor: pointer; font-weight: 600;
      width: 100%; margin-top: 8px;
    }
    button.primary:hover { background: #c73652; }
    button.secondary {
      background: transparent; color: #e94560; border: 1px solid #e94560;
      padding: 10px 20px; border-radius: 8px; font-size: 0.9rem; cursor: pointer;
      font-weight: 600; width: 100%; margin-top: 8px;
    }
    button.secondary:hover { background: rgba(233,69,96,0.1); }

    /* Admin pricing (hidden by default) */
    .admin-section { margin-top: 16px; display: none; }
    .admin-section.visible { display: block; }
    .price-input-row { display: flex; flex-direction: column; gap: 8px; margin-bottom: 8px; }

    /* Results */
    .results { margin-top: 16px; }
    .result-group {
      background: #1a1a2e; border-radius: 8px; padding: 14px;
      margin-bottom: 10px; border: 1px solid #0f3460;
    }
    .result-group h3 { font-size: 0.85rem; color: #e94560; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .result-line { display: flex; justify-content: space-between; padding: 4px 0; font-size: 0.9rem; }
    .result-line .label { color: #a0a0b0; }
    .result-line .value { color: #fff; font-weight: 600; }
    .total-line {
      display: flex; justify-content: space-between; padding: 12px 0 0;
      margin-top: 8px; border-top: 2px solid #e94560; font-size: 1.1rem;
    }
    .total-line .label { color: #fff; font-weight: 700; }
    .total-line .value { color: #e94560; font-weight: 700; font-size: 1.3rem; }
    .box-color-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 6px; vertical-align: middle; }

    /* Share buttons */
    .share-buttons { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    .share-buttons button {
      flex: 1; min-width: 120px; background: #16213e; color: #e0e0e0;
      border: 1px solid #0f3460; padding: 10px 16px; border-radius: 8px;
      font-size: 0.85rem; cursor: pointer; font-weight: 600; text-align: center;
    }
    .share-buttons button:hover { border-color: #e94560; color: #fff; }
    .share-buttons button.copied { background: #2d5a27; border-color: #3a7a34; color: #7dde6a; }

    /* Toast */
    .toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
      background: #2d5a27; color: #7dde6a; padding: 12px 24px; border-radius: 8px;
      font-size: 0.9rem; font-weight: 600; z-index: 1000; opacity: 0;
      transition: opacity 0.3s; pointer-events: none;
    }
    .toast.show { opacity: 1; }

    /* 3D viewer */
    .viewer-wrap { display: flex; flex-direction: column; min-width: 0; overflow: hidden; }
    #viewer { height: 500px; border-radius: 12px; overflow: hidden; cursor: grab; width: 100%; }
    #viewer:active { cursor: grabbing; }
    .viewer-controls { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    .viewer-controls button {
      background: #16213e; color: #a0a0b0; border: 1px solid #0f3460;
      padding: 6px 14px; border-radius: 6px; font-size: 0.8rem; cursor: pointer;
    }
    .viewer-controls button:hover { border-color: #e94560; color: #fff; }
    .viewer-controls button.active { border-color: #e94560; color: #e94560; }

    /* Cedar features callout */
    .features {
      display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap;
    }
    .feature-tag {
      background: rgba(233,69,96,0.1); border: 1px solid rgba(233,69,96,0.2);
      color: #e94560; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem;
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }
  </style>
</head>
<body>
  <header>
    <h1>üåø Garden Box Builder</h1>
    <p>Design your custom cedar raised beds & get an instant quote</p>
    <div class="features">
      <span class="feature-tag">ü™µ Western Red Cedar</span>
      <span class="feature-tag">üî© Built to Last</span>
      <span class="feature-tag">üìê Custom Sizes</span>
    </div>
  </header>

  <div class="container">
    <div class="left-col">
      <div class="panel">
        <h2>üìê Design Your Boxes</h2>
        <div id="box-list"></div>
        <button class="secondary" onclick="addBox()">+ Add Another Box</button>
      </div>

      <!-- Admin pricing panel (hidden, ?admin=true to show) -->
      <div class="panel admin-section" id="admin-panel">
        <h2>üîß Pricing (Admin)</h2>
        <div class="price-input-row">
          <div class="field">
            <label>Fence Picket Cost (6')</label>
            <input type="number" id="price-picket" value="3.50" step="0.01" min="0" onchange="calculate()">
          </div>
          <div class="field">
            <label>2√ó4 S4S Cost (8')</label>
            <input type="number" id="price-2x4" value="8.00" step="0.01" min="0" onchange="calculate()">
          </div>
        </div>
        <div class="price-input-row">
          <div class="field">
            <label>Screws Cost (per lb)</label>
            <input type="number" id="price-screws" value="8.00" step="0.01" min="0" onchange="calculate()">
          </div>
          <div class="field">
            <label>Screws/box (lbs)</label>
            <input type="number" id="screws-per-box" value="0.5" step="0.1" min="0" onchange="calculate()">
          </div>
        </div>
        <div class="price-input-row">
          <div class="field">
            <label>Markup Multiplier</label>
            <input type="number" id="markup" value="2.0" step="0.1" min="1" onchange="calculate()">
          </div>
          <div class="field">
            <label>Labor per Box ($)</label>
            <input type="number" id="labor-per-box" value="20.00" step="1" min="0" onchange="calculate()">
          </div>
        </div>
      </div>

      <div class="panel results" id="results-panel" style="display:none;">
        <h2>üí∞ Your Quote</h2>
        <div id="results-content"></div>
        <div class="share-buttons">
          <button onclick="copyBuildSheet()" id="copy-btn">üìã Copy Build Sheet</button>
          <button onclick="shareBuildSheet()">üì§ Share</button>
        </div>
      </div>
    </div>

    <div class="viewer-wrap">
      <div class="panel viewer-panel" style="padding:0;overflow:hidden;">
        <div id="viewer"></div>
      </div>
      <div class="viewer-controls">
        <button onclick="resetCamera()">Reset View</button>
        <button onclick="toggleWireframe()" id="wireframe-btn">Wireframe</button>
        <button onclick="toggleExplode()" id="explode-btn">Explode View</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
    }
  }
  </script>
  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // ---- Admin mode ----
    const isAdmin = new URLSearchParams(window.location.search).has('admin');
    if (isAdmin) {
      document.getElementById('admin-panel').classList.add('visible');
    }

    // ---- Constants ----
    const PICKET_WIDTH = 5.5;
    const PICKET_THICKNESS = 0.625;
    const PICKET_LENGTH = 72;
    const POST_WIDTH = 1.5;
    const POST_DEPTH = 3.5;

    const BOX_COLORS = [
      0xd4a574, 0xc49a6c, 0xb8906a, 0xcfaa7a, 0xbf9060,
      0xd4aa70, 0xc8a070, 0xb89868
    ];

    let scene, camera, renderer, controls;
    let boxMeshes = [];
    let wireframeMode = false;
    let explodeMode = false;

    window.boxes = [
      { length: 72, width: 36, pickets: 3, qty: 1 }
    ];

    // ---- Toast ----
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2500);
    }

    // ---- Init Three.js ----
    function initViewer() {
      const container = document.getElementById('viewer');
      const w = container.clientWidth;
      const h = container.clientHeight || 500;

      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x1a1a2e);
      camera = new THREE.PerspectiveCamera(45, w / h, 0.1, 10000);
      camera.position.set(120, 80, 120);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(w, h);
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.shadowMap.enabled = true;
      container.appendChild(renderer.domElement);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.maxPolarAngle = Math.PI / 2;

      const ambient = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambient);
      const dir = new THREE.DirectionalLight(0xffffff, 0.8);
      dir.position.set(100, 150, 100);
      dir.castShadow = true;
      scene.add(dir);
      const dir2 = new THREE.DirectionalLight(0xffffff, 0.3);
      dir2.position.set(-50, 80, -50);
      scene.add(dir2);

      const groundGeo = new THREE.PlaneGeometry(1000, 1000);
      const groundMat = new THREE.MeshStandardMaterial({ color: 0x2d5a27, roughness: 0.9 });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      ground.position.y = -0.5;
      ground.receiveShadow = true;
      scene.add(ground);

      const grid = new THREE.GridHelper(200, 20, 0x3a7a34, 0x3a7a34);
      grid.position.y = -0.4;
      grid.material.opacity = 0.3;
      grid.material.transparent = true;
      scene.add(grid);

      window.addEventListener('resize', () => {
        const w = container.clientWidth;
        const h = container.clientHeight;
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
        renderer.setSize(w, h);
      });

      animate();
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    // ---- Wood Texture ----
    function createWoodTexture(baseColor, isPost) {
      const canvas = document.createElement('canvas');
      const w = isPost ? 64 : 256;
      const h = isPost ? 256 : 64;
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      const c = new THREE.Color(baseColor);
      const r = Math.floor(c.r * 255), g = Math.floor(c.g * 255), b = Math.floor(c.b * 255);

      ctx.fillStyle = `rgb(${r},${g},${b})`;
      ctx.fillRect(0, 0, w, h);

      const grainCount = isPost ? 8 + Math.floor(Math.random() * 6) : 12 + Math.floor(Math.random() * 8);
      for (let i = 0; i < grainCount; i++) {
        const darkness = 0.88 + Math.random() * 0.08;
        ctx.strokeStyle = `rgba(${Math.floor(r*darkness)},${Math.floor(g*darkness)},${Math.floor(b*darkness)},${0.3 + Math.random() * 0.4})`;
        ctx.lineWidth = 0.5 + Math.random() * 1.5;
        ctx.beginPath();
        if (isPost) {
          const x = Math.random() * w;
          ctx.moveTo(x + (Math.random()-0.5)*3, 0);
          for (let y = 0; y < h; y += 8) ctx.lineTo(x + (Math.random()-0.5)*4, y);
        } else {
          const y = Math.random() * h;
          ctx.moveTo(0, y + (Math.random()-0.5)*3);
          for (let x = 0; x < w; x += 8) ctx.lineTo(x, y + (Math.random()-0.5)*4);
        }
        ctx.stroke();
      }

      if (Math.random() > 0.6) {
        const kx = w*0.2 + Math.random()*w*0.6, ky = h*0.2 + Math.random()*h*0.6, kr = 2 + Math.random()*4;
        const grad = ctx.createRadialGradient(kx, ky, 0, kx, ky, kr);
        grad.addColorStop(0, `rgba(${Math.floor(r*0.6)},${Math.floor(g*0.55)},${Math.floor(b*0.5)},0.6)`);
        grad.addColorStop(1, `rgba(${r},${g},${b},0)`);
        ctx.fillStyle = grad;
        ctx.fillRect(kx-kr, ky-kr, kr*2, kr*2);
      }

      if (!isPost) {
        const edgeGrad = ctx.createLinearGradient(0, 0, 0, h);
        edgeGrad.addColorStop(0, 'rgba(0,0,0,0.15)');
        edgeGrad.addColorStop(0.08, 'rgba(0,0,0,0)');
        edgeGrad.addColorStop(0.92, 'rgba(0,0,0,0)');
        edgeGrad.addColorStop(1, 'rgba(0,0,0,0.15)');
        ctx.fillStyle = edgeGrad;
        ctx.fillRect(0, 0, w, h);
      }

      const texture = new THREE.CanvasTexture(canvas);
      texture.wrapS = THREE.RepeatWrapping;
      texture.wrapT = THREE.RepeatWrapping;
      return texture;
    }

    function createCedarMaterial(color, isPost) {
      return new THREE.MeshStandardMaterial({
        map: createWoodTexture(color, isPost),
        color: 0xffffff, roughness: 0.85, metalness: 0.0, wireframe: wireframeMode
      });
    }

    // ---- Build Box ----
    function buildBox(lengthIn, widthIn, numPickets, offsetX, offsetZ, colorIndex) {
      const group = new THREE.Group();
      const height = numPickets * PICKET_WIDTH;
      const baseColor = BOX_COLORS[colorIndex % BOX_COLORS.length];
      const postColor = new THREE.Color(baseColor).multiplyScalar(0.75).getHex();
      const explodeOffset = explodeMode ? 8 : 0;

      const postGeo = new THREE.BoxGeometry(POST_DEPTH, height, POST_WIDTH);
      const postMat = createCedarMaterial(postColor, true);
      [[0,0],[lengthIn-POST_DEPTH,0],[0,widthIn-POST_WIDTH],[lengthIn-POST_DEPTH,widthIn-POST_WIDTH]].forEach(([x,z], i) => {
        const post = new THREE.Mesh(postGeo, postMat);
        post.position.set(
          x + POST_DEPTH/2 + (explodeMode ? (i%2===0 ? -explodeOffset : explodeOffset) : 0),
          height/2,
          z + POST_WIDTH/2 + (explodeMode ? (i<2 ? -explodeOffset : explodeOffset) : 0)
        );
        post.castShadow = true;
        group.add(post);
      });

      // Brace posts every 36" max on long sides
      const numBraces = Math.max(0, Math.ceil(lengthIn / 36) - 1);
      if (numBraces > 0) {
        const spacing = lengthIn / (numBraces + 1);
        const midPostGeo = new THREE.BoxGeometry(POST_DEPTH, height, POST_WIDTH);
        for (let b = 1; b <= numBraces; b++) {
          const midX = spacing * b - POST_DEPTH / 2;
          [0, widthIn-POST_WIDTH].forEach((z, i) => {
            const post = new THREE.Mesh(midPostGeo, createCedarMaterial(postColor, true));
            post.position.set(midX + POST_DEPTH/2, height/2, z + POST_WIDTH/2 + (explodeMode ? (i===0 ? -explodeOffset : explodeOffset) : 0));
            post.castShadow = true;
            group.add(post);
          });
        }
      }

      for (let row = 0; row < numPickets; row++) {
        const y = row * PICKET_WIDTH + PICKET_WIDTH/2;
        const variation = 0.95 + Math.random()*0.1;
        const pColor = new THREE.Color(baseColor).multiplyScalar(variation).getHex();

        const longGeo = new THREE.BoxGeometry(lengthIn, PICKET_WIDTH, PICKET_THICKNESS);
        const front = new THREE.Mesh(longGeo, createCedarMaterial(pColor, false));
        front.position.set(lengthIn/2, y, -PICKET_THICKNESS/2 + (explodeMode ? -explodeOffset : 0));
        front.castShadow = true;
        group.add(front);

        const back = new THREE.Mesh(longGeo, createCedarMaterial(pColor, false));
        back.position.set(lengthIn/2, y, widthIn + PICKET_THICKNESS/2 + (explodeMode ? explodeOffset : 0));
        back.castShadow = true;
        group.add(back);

        const shortGeo = new THREE.BoxGeometry(PICKET_THICKNESS, PICKET_WIDTH, widthIn);
        const pColor2 = new THREE.Color(baseColor).multiplyScalar(0.95 + Math.random()*0.1).getHex();
        const left = new THREE.Mesh(shortGeo, createCedarMaterial(pColor2, false));
        left.position.set(-PICKET_THICKNESS/2 + (explodeMode ? -explodeOffset : 0), y, widthIn/2);
        left.castShadow = true;
        group.add(left);

        const right = new THREE.Mesh(shortGeo, createCedarMaterial(pColor2, false));
        right.position.set(lengthIn + PICKET_THICKNESS/2 + (explodeMode ? explodeOffset : 0), y, widthIn/2);
        right.castShadow = true;
        group.add(right);
      }

      group.position.set(offsetX, 0, offsetZ);
      return group;
    }

    // ---- Scene Layout ----
    function rebuildScene() {
      boxMeshes.forEach(m => scene.remove(m));
      boxMeshes = [];
      const allBoxes = [];
      window.boxes.forEach(box => { for (let q = 0; q < box.qty; q++) allBoxes.push({...box}); });
      if (!allBoxes.length) return;

      const sorted = [...allBoxes].sort((a,b) => (b.length*b.width) - (a.length*a.width));
      const gap = 12;
      const rows = [];

      sorted.forEach(box => {
        let bestRow = -1, bestX = Infinity;
        for (let r = 0; r < rows.length; r++) {
          const last = rows[r].items[rows[r].items.length-1];
          const nextX = last ? last.x + last.box.length + gap : 0;
          if (nextX + box.length < bestX + box.length*2) { bestRow = r; bestX = nextX; }
        }
        const maxWidth = sorted[0].length * 3 + gap * 2;
        if (bestRow === -1 || bestX + box.length > maxWidth) {
          rows.push({ z: 0, depth: box.width, items: [{ box, x: 0 }] });
        } else {
          rows[bestRow].items.push({ box, x: bestX });
          rows[bestRow].depth = Math.max(rows[bestRow].depth, box.width);
        }
      });

      let currentZ = 0;
      rows.forEach(row => { row.z = currentZ; currentZ += row.depth + gap; });

      let colorIdx = 0;
      rows.forEach(row => {
        row.items.forEach(item => {
          const zOffset = row.z + (row.depth - item.box.width)/2;
          const group = buildBox(item.box.length, item.box.width, item.box.pickets, item.x, zOffset, colorIdx);
          scene.add(group);
          boxMeshes.push(group);
          colorIdx++;
        });
      });
    }

    window.resetCamera = function() { camera.position.set(120, 80, 120); controls.target.set(0, 10, 0); controls.update(); };
    window.toggleWireframe = function() { wireframeMode = !wireframeMode; document.getElementById('wireframe-btn').classList.toggle('active', wireframeMode); rebuildScene(); };
    window.toggleExplode = function() { explodeMode = !explodeMode; document.getElementById('explode-btn').classList.toggle('active', explodeMode); rebuildScene(); };

    // ---- Material Calculations ----
    function calculateMaterials(box) {
      const height = box.pickets * PICKET_WIDTH;
      const picketsPerRowLong = Math.ceil(box.length / PICKET_LENGTH);
      const longSidePickets = picketsPerRowLong * box.pickets * 2;
      const picketsPerRowShort = Math.ceil(box.width / PICKET_LENGTH);
      const shortSidePickets = picketsPerRowShort * box.pickets * 2;
      const totalPickets = longSidePickets + shortSidePickets;
      const numBraces = Math.max(0, Math.ceil(box.length / 36) - 1);
      const bracePosts = numBraces * 2; // one on each long side
      const totalPosts = 4 + bracePosts;
      const postsPerBoard = Math.floor(96 / height);
      const boardsNeeded = Math.ceil(totalPosts / postsPerBoard);
      return { pickets: totalPickets, posts: totalPosts, postsPerBoard, boards2x4: boardsNeeded, height };
    }

    // ---- Formatting helpers ----
    function fmtDim(box) {
      const h = box.pickets * PICKET_WIDTH;
      const lFt = box.length / 12, wFt = box.width / 12, hIn = h;
      return `${lFt % 1 === 0 ? lFt + "'" : box.length + '"'} √ó ${wFt % 1 === 0 ? wFt + "'" : box.width + '"'} √ó ${hIn}"`;
    }

    // ---- Calculate & Render Quote ----
    window.calculate = function() {
      const pricePicket = parseFloat(document.getElementById('price-picket').value) || 0;
      const price2x4 = parseFloat(document.getElementById('price-2x4').value) || 0;
      const priceScrews = parseFloat(document.getElementById('price-screws').value) || 0;
      const screwsPerBox = parseFloat(document.getElementById('screws-per-box').value) || 0;
      const markup = parseFloat(document.getElementById('markup').value) || 2.0;
      const laborPerBox = parseFloat(document.getElementById('labor-per-box').value) || 0;

      let html = '';
      let grandTotal = 0;

      window.boxes.forEach((box, i) => {
        const m = calculateMaterials(box);
        const materialCost = (m.pickets * pricePicket + m.boards2x4 * price2x4 + priceScrews * screwsPerBox);
        const boxPrice = (materialCost * markup + laborPerBox) * box.qty;
        const perUnit = materialCost * markup + laborPerBox;
        grandTotal += boxPrice;

        const dimLabel = fmtDim(box);
        const color = BOX_COLORS[i % BOX_COLORS.length];
        const colorHex = '#' + color.toString(16).padStart(6, '0');

        html += `<div class="result-group">
          <h3><span class="box-color-dot" style="background:${colorHex}"></span>${dimLabel}${box.qty > 1 ? ` √ó ${box.qty}` : ''}</h3>
          <div class="result-line"><span class="label">Cedar fence pickets</span><span class="value">${box.pickets} boards tall</span></div>
          <div class="result-line"><span class="label">Construction</span><span class="value">4 corners${m.posts > 4 ? ` + ${m.posts - 4} brace${m.posts - 4 > 1 ? 's' : ''}` : ''}</span></div>
          <div class="result-line" style="border-top:1px solid #0f3460;padding-top:6px;margin-top:4px">
            <span class="label" style="color:#fff">${box.qty > 1 ? `$${perUnit.toFixed(0)} each √ó ${box.qty}` : 'Price'}</span>
            <span class="value" style="color:#e94560">$${boxPrice.toFixed(0)}</span>
          </div>
        </div>`;
      });

      html += `<div class="total-line"><span class="label">Estimated Total</span><span class="value">$${grandTotal.toFixed(0)}</span></div>`;
      html += `<p style="font-size:0.75rem;color:#666;margin-top:8px;">All boxes built with western red cedar. Price may vary based on current lumber costs. Contact us to confirm your order.</p>`;

      document.getElementById('results-content').innerHTML = html;
      document.getElementById('results-panel').style.display = 'block';
      rebuildScene();
    };

    // ---- Build Sheet Text ----
    window.generateBuildSheet = function() {
      const date = new Date().toLocaleDateString();
      let lines = [];
      lines.push('üåø GARDEN BOX BUILD SHEET');
      lines.push(`Date: ${date}`);
      lines.push('‚îÄ'.repeat(30));
      lines.push('');

      const markup = parseFloat(document.getElementById('markup').value) || 2.0;
      const laborPerBox = parseFloat(document.getElementById('labor-per-box').value) || 0;
      const pricePicket = parseFloat(document.getElementById('price-picket').value) || 0;
      const price2x4 = parseFloat(document.getElementById('price-2x4').value) || 0;
      const priceScrews = parseFloat(document.getElementById('price-screws').value) || 0;
      const screwsPerBox = parseFloat(document.getElementById('screws-per-box').value) || 0;

      let grandTotal = 0;
      let totalBoxes = 0;

      window.boxes.forEach((box, i) => {
        const m = calculateMaterials(box);
        const materialCost = m.pickets * pricePicket + m.boards2x4 * price2x4 + priceScrews * screwsPerBox;
        const perUnit = materialCost * markup + laborPerBox;
        const boxPrice = perUnit * box.qty;
        grandTotal += boxPrice;
        totalBoxes += box.qty;

        const dim = fmtDim(box);
        lines.push(`üì¶ Box ${i + 1}: ${dim}`);
        lines.push(`   ${box.pickets} boards tall, cedar construction`);
        if (box.qty > 1) {
          lines.push(`   Qty: ${box.qty} √ó $${perUnit.toFixed(0)} = $${boxPrice.toFixed(0)}`);
        } else {
          lines.push(`   Price: $${boxPrice.toFixed(0)}`);
        }
        lines.push('');
      });

      lines.push('‚îÄ'.repeat(30));
      lines.push(`Total: ${totalBoxes} box${totalBoxes > 1 ? 'es' : ''} ‚Äî $${grandTotal.toFixed(0)}`);
      lines.push('');
      lines.push('Western red cedar ‚Ä¢ Built to order');
      lines.push('');
      lines.push(`Preview: ${window.location.href}`);

      return lines.join('\n');
    };

    window.copyBuildSheet = function() {
      const text = generateBuildSheet();
      navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById('copy-btn');
        btn.classList.add('copied');
        btn.textContent = '‚úÖ Copied!';
        showToast('Build sheet copied to clipboard!');
        setTimeout(() => { btn.classList.remove('copied'); btn.textContent = 'üìã Copy Build Sheet'; }, 2500);
      });
    };

    window.shareBuildSheet = function() {
      const text = generateBuildSheet();
      if (navigator.share) {
        navigator.share({ title: 'Garden Box Build Sheet', text: text }).catch(() => {});
      } else {
        // Fallback: copy
        navigator.clipboard.writeText(text).then(() => showToast('Build sheet copied to clipboard!'));
      }
    };

    // ---- UI: Box List ----
    window.addBox = function() {
      window.boxes.push({ length: 72, width: 36, pickets: 3, qty: 1 });
      renderBoxList();
      calculate();
    };

    window.removeBox = function(idx) {
      if (window.boxes.length <= 1) return;
      window.boxes.splice(idx, 1);
      renderBoxList();
      calculate();
    };

    window.updateBox = function(idx, field, value) {
      const num = parseFloat(value);
      if (isNaN(num) || num <= 0) return;
      window.boxes[idx][field] = field === 'qty' || field === 'pickets' ? Math.round(num) : num;
      calculate();
    };

    window.toggleBox = function(idx) {
      const el = document.querySelector(`[data-box-idx="${idx}"]`);
      if (el) el.classList.toggle('collapsed');
    };

    function renderBoxList() {
      const list = document.getElementById('box-list');
      list.innerHTML = window.boxes.map((box, i) => {
        const dim = fmtDim(box);
        const summary = `${dim} ‚Äî qty ${box.qty}`;
        return `
        <div class="box-entry" data-box-idx="${i}">
          <div class="box-header" onclick="toggleBox(${i})">
            <div class="header-left">
              <span class="toggle-icon">‚ñº</span>
              <span>Box ${i + 1}</span>
              <span class="box-summary">${summary}</span>
            </div>
            <div class="header-actions">
              ${window.boxes.length > 1 ? `<button class="remove-btn" onclick="event.stopPropagation();removeBox(${i})">‚úï</button>` : ''}
            </div>
          </div>
          <div class="box-body">
            <div class="field-row">
              <div class="field">
                <label>Length (inches)</label>
                <input type="number" value="${box.length}" min="12" step="1" onchange="updateBox(${i},'length',this.value)">
              </div>
              <div class="field">
                <label>Width (inches)</label>
                <input type="number" value="${box.width}" min="12" step="1" onchange="updateBox(${i},'width',this.value)">
              </div>
              <div class="field">
                <label>Height (boards tall)</label>
                <input type="number" value="${box.pickets}" min="1" max="6" step="1" onchange="updateBox(${i},'pickets',this.value)">
              </div>
            </div>
            <div class="qty-row">
              <div class="field">
                <label>How many?</label>
                <input type="number" value="${box.qty}" min="1" step="1" onchange="updateBox(${i},'qty',this.value)">
              </div>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    // ---- Init ----
    initViewer();
    renderBoxList();
    calculate();
  </script>
</body>
</html>
